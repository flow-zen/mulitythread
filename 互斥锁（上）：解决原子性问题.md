一个或者多个操作在CPU执行的过程中不被中断的特性，称为“原子性”。

原子性问题的源头是线程切换，“同一时刻只有一个线程执行”这个条件非常重要，我们称之为互斥。

## 简易锁模型
<img width="642" height="531" alt="image" src="https://github.com/user-attachments/assets/c65a5014-317f-4909-968d-ae6364aaf391" />

我们把一段需要互斥执行的代码称为临界区。线程在进入临界区之前，首先尝试加锁lock()，如果成功，则进入临界区，此时我们称这个线程持有锁；否则呢就等待，直到持有锁的线程解锁；持有锁的线程执行完临界区的代码后，执行解锁unlock()。

## 改进后的锁模型
**“锁必须一对一地罩住资源，否则就形同虚设。”**  
Java 里最容易“罩错”的场景就是把 `this` 当锁，却保护着**别的**对象。下面用两个正反例让你一眼看出“资源-锁”对应关系的重要性。

--------------------------------------------------
一、Bug 版：锁了“自家门”，保护“他家资产”
```java
class Account {
    private int balance;          // 受保护资源 R
    private final Object lock = new Object(); // 专属锁 LR

    void transfer(Account target, int amt){
        synchronized (this) {     // ❌ 只锁了“自己”
            balance -= amt;
            target.balance += amt; // 对方 balance 也在临界区，却没用同一把锁！
        }
    }
}
```
- 线程 1：a→b 转账  
- 线程 2：b→c 转账  
两条线程同时改 `b.balance`，一个用 `a.this` 当锁，一个用 `b.this` 当锁，**没有互斥**，结果**丢更新**。

--------------------------------------------------
二、改进版：资源-锁一一对应
```java
class Account {
    private int balance;
    // 静态全局锁，罩住“所有账户”这一资源集合
    private static final Object globalLock = new Object();

    void transfer(Account target, int amt){
        synchronized (globalLock) {  // ✅ 一把锁罩住整个临界区
            balance -= amt;
            target.balance += amt;
        }
    }
}
```
此时无论多少账户并发转账，**同一时刻只有一个线程能进入临界区**，`balance` 的所有读写都被 `globalLock` 串行化，数据正确。

--------------------------------------------------
三、进阶版：粒度细化，但**资源-锁仍保持对应**
```java
void transfer(Account target, int amt){
    // 按账户序号定锁顺序，避免死锁，但核心思想不变：
    // “参与转账的两个账户”是本次受保护资源，必须被**同一把或成对锁**罩住
    Account first  = this.hashCode() < target.hashCode() ? this : target;
    Account second = this.hashCode() < target.hashCode() ? target : this;
    synchronized (first) {
        synchronized (second) {
            this.balance -= amt;
            target.balance += amt;
        }
    }
}
```
虽然锁粒度变细，但**资源与锁的对应关系始终清晰**：  
受保护资源 R = {this.balance, target.balance}  
锁 LR = {first, second}，且成对使用，绝不“锁 A 护 B”。

--------------------------------------------------
